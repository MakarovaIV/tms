{% extends 'root.html' %}

{% block content %}
<style>
	.treeview span.icon.node-icon {
		margin-right: 1rem;
	}
</style>
<link href="https://cdn.jsdelivr.net/npm/jquery-treegrid@0.3.0/css/jquery.treegrid.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-treegrid@0.3.0/js/jquery.treegrid.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/extensions/treegrid/bootstrap-table-treegrid.min.js"></script>
<script>
	var submitHandler = function() {
		var projects = Array.from(document.querySelectorAll('.tp-proj')).map(p => +p.querySelector('input').value);
		var suits = Array.from(document.querySelectorAll('.tp-suit')).map(s => +s.querySelector('input').value);
		var cases = Array.from(document.querySelectorAll('.tp-case')).map(c => +c.querySelector('input').value);

		myform.proj.value = JSON.stringify(projects);
		myform.suit.value = JSON.stringify(suits);
		myform.tc.value = JSON.stringify(cases);

		myform.submit();
	};

	var addProjectHandler = function() {
		var selectedProjects = $('#addProjectTable').bootstrapTable('getSelections');
		var newNodes = selectedProjects.map(p => ({
			"id": p.id,
			"name": p.name,
			"type": "tp-proj",
			"action": '<button type="button" class="btn btn-info" onclick="addSuitHandler(event,' + p.id + ')">Add suit</button>'
		}));
		$('#tree').bootstrapTable('append', newNodes);
		bootstrap.Modal.getInstance('#addProjectModal').hide()
	};

	var addSuitHandler = function() {
	}

	var addCaseHandler = function() {
	}

	var onAddProjectModalOpen = function() {
		$('#addProjectTable').bootstrapTable({
			url: "{% url 'getprojects' %}",
			columns: [{
				checkbox: true
			}, {
				field: 'id',
				title: 'ID'
			}, {
				field: 'name',
				title: 'Project Name'
			}]
		})
	};

	var removeHandler = function() {
		var selectedNodes = $('#tree').bootstrapTable('getSelections');
		if (selectedNodes && selectedNodes.length > 0) {
			$('#tree').bootstrapTable('remove', {
				field: "id",
				values: selectedNodes.map(n => n.id)
			});
		}
	};

	$(function() {
		addProjectBtn.addEventListener('click', onAddProjectModalOpen);
		var tree = $('#tree')
		
		tree.bootstrapTable({
			data: {{ structure|safe }},
			idField: "id",
			showColumns: true,
			treeShowField: 'name',
			parentIdField: 'parentId',
			rowStyle :  function(row, index) {
				return {
					classes: row.type
				};
			},
			columns: [
				{
					field: "ck",
					checkbox: true
				},
				{
					field: "name",
					title: "Name"
				},
				{
					field: "action",
					title: " "
				}
		  	],
			onPostBody: function() {
				var columns = tree.bootstrapTable('getOptions').columns

				if (columns && columns[0][1].visible) {
					tree.treegrid({
						treeColumn: 1,
						onChange: function() {
							tree.bootstrapTable('resetView')
						}
					})
				}
			}
		});
	});

</script>
	<div class="plan-wrapper">
		{% if user.is_authenticated %}
			{% if plan and plan.pk %}
			<h3>Edit test-plan</h3>
			{% else %}
			<h3>Create new test-plan</h3>
			{% endif %}

			{% if plan and plan.pk %}
			<form action="{% url 'plan_update' pk=plan.pk %}" method="post" id="myform">
			{% else %}
			<form action="{% url 'plan_create' %}" method="post" id="myform">
			{% endif %}



			{% csrf_token %}
				<input name="user_id" value="{{ user_id }}" class="invisible"/>
				<input name="modified_by_id" value="{{ modified_by_id }}" class="invisible"/>
				<input name="proj" class="invisible"/>
				<input name="suit" class="invisible"/>
				<input name="tc" class="invisible"/>
				<p>
					<label for="TPName">Test-plan name</label>
					<input name="name" id="TPName" value="{{ name }}"/>
				</p>
				<p>
					<label for="Desc">Description</label>
					<textarea name="desc" id="Desc">{{ desc }}</textarea>
				</p>
				<select name="status">
					<option {% if 'IN PROGRESS' == status %} selected {% endif %}>IN PROGRESS</option>
					<option {% if 'DONE' == status %} selected {% endif %}>DONE</option>
					<option {% if 'CANCELLED' == status %} selected {% endif %}>CANCELLED</option>
				</select>
			</form>
			</form>
			<div class="btn-toolbar">
				<button id="addProjectBtn" class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#addProjectModal">Add Project</button>
				<button id="removeItemsBtn" class="btn btn-danger" type="button" onclick="removeHandler()">Remove selected</button>
			</div>
			<table id="tree"></table>
			<button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#saveModal">Save</button>
			<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="addProjectModalLabel">Add project</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<table id="addProjectTable"></table>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn btn-primary" onclick="addProjectHandler()">Add</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="saveModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="saveModalLabel">Are you sure to save changes?</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn btn-primary" onclick="submitHandler()">Save changes</button>
						</div>
					</div>
				</div>
			</div>
		{% else %}
			<p>You are not authorized</p>
		{% endif %}
	</div>


{% endblock %}